generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & ATHLETE
// ============================================

model User {
  id          String      @id @default(cuid())
  clerkId     String      @unique
  email       String      @unique
  accountType AccountType @default(ATHLETE) // Primary mode, but users can be both
  role        Role        @default(ATHLETE)
  
  // Suspension
  suspendedAt    DateTime?  // If set, user is suspended
  suspendedBy    String?    // ID of admin who suspended
  suspendReason  String?    // Reason for suspension
  
  // Review permissions (for peer reviews on social feed)
  canReview         Boolean   @default(true)   // Can this user review submissions?
  reviewBannedAt    DateTime? // When they were banned from reviewing
  reviewBannedBy    String?   // Admin who banned them
  reviewBanReason   String?   // Why they were banned
  reviewCount       Int       @default(0)      // Total reviews given
  reviewAccuracy    Float?    // % of reviews that matched final outcome (quality metric)
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // User's own athlete profile (if they compete themselves)
  athlete Athlete? @relation("UserAthlete")

  // Child athletes this user manages (if they're a parent)
  managedAthletes Athlete[] @relation("ParentManaged")

  // Gym relationships
  gymMemberships GymMember[] // Gyms this user is a member of
  ownedGyms      Gym[]       @relation("GymOwner") // Gyms this user owns
}

enum AccountType {
  ATHLETE // Primarily competing for themselves
  PARENT  // Primarily managing child athletes (but can also compete)
}

enum Role {
  ATHLETE
  PARENT
  COACH
  GYM_ADMIN
  SYSTEM_ADMIN
}

model Athlete {
  id String @id @default(cuid())

  // For adult athletes who have their own account
  userId String? @unique
  user   User?   @relation("UserAthlete", fields: [userId], references: [id])

  // For child athletes managed by a parent
  parentId String?
  parent   User?   @relation("ParentManaged", fields: [parentId], references: [id])

  displayName String
  dateOfBirth DateTime
  gender      String // Maps to division
  avatarUrl   String?
  isMinor     Boolean  @default(false) // Calculated from DOB, for quick filtering
  
  // Privacy settings (COPPA compliance for minors)
  isPublicProfile Boolean @default(false) // Can appear in public lists (leaderboards, gym members)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  domainLevels   DomainLevel[]
  xpTransactions XPTransaction[]
  submissions    ChallengeSubmission[]
  disciplines    AthleteDiscipline[]   // Primary training disciplines
}

// Join table: Athlete <-> Discipline (many-to-many)
model AthleteDiscipline {
  id           String @id @default(cuid())
  athleteId    String
  disciplineId String
  createdAt    DateTime @default(now())

  athlete    Athlete    @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  discipline Discipline @relation(fields: [disciplineId], references: [id], onDelete: Cascade)

  @@unique([athleteId, disciplineId])
}

// ============================================
// DOMAINS & CATEGORIES (Admin-Configurable)
// ============================================

model Domain {
  id          String  @id @default(cuid())
  name        String  @unique // Strength, Skill, Endurance, Speed
  slug        String  @unique
  description String?
  icon        String? // Icon name or URL
  color       String? // Hex color for UI
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categories     Category[]
  levels         DomainLevel[]
  xpTransactions XPTransaction[]
  xpThresholds   XPThreshold[] // Configurable XP per sublevel

  // Challenges that award XP to this domain
  primaryChallenges   Challenge[] @relation("PrimaryDomain")
  secondaryChallenges Challenge[] @relation("SecondaryDomain")
  tertiaryChallenges  Challenge[] @relation("TertiaryDomain")
}

// XP required per sublevel, configurable per domain per rank
model XPThreshold {
  id         String @id @default(cuid())
  domainId   String
  rank       String // F, E, D, C, B, A, S
  sublevel   Int // 0-9
  xpRequired Int // XP needed to reach this sublevel
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  domain Domain @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@unique([domainId, rank, sublevel])
}

model Category {
  id          String  @id @default(cuid())
  domainId    String
  name        String // e.g., "Balance", "Grip Strength", "Climbing"
  slug        String
  description String?
  icon        String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  domain     Domain      @relation(fields: [domainId], references: [id], onDelete: Cascade)
  challenges ChallengeCategory[] // Many-to-many with challenges

  @@unique([domainId, slug])
}

// ============================================
// DISCIPLINES (Sports/Activities - Admin-Configurable)
// ============================================

model Discipline {
  id          String  @id @default(cuid())
  name        String  @unique // e.g., "Ninja", "Calisthenics", "Parkour", "CrossFit"
  slug        String  @unique
  description String?
  icon        String?
  color       String? // Hex color for UI
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  challenges ChallengeDiscipline[] // Many-to-many with challenges
  equipment  DisciplineEquipment[] // Many-to-many with equipment
  gyms       GymDiscipline[]       // Many-to-many with gyms
  athletes   AthleteDiscipline[]   // Many-to-many with athletes
}

// ============================================
// EQUIPMENT (Admin-Configurable)
// ============================================

model Equipment {
  id          String  @id @default(cuid())
  name        String  @unique // e.g., "Salmon Ladder", "Warped Wall", "Pull-up Bar"
  slug        String  @unique
  description String?
  icon        String?
  imageUrl    String? // Photo of the equipment
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  challenges  ChallengeEquipment[]  // Many-to-many with challenges
  disciplines DisciplineEquipment[] // Many-to-many with disciplines
  gyms        GymEquipment[]        // Many-to-many with gyms
  packages    EquipmentPackageItem[] // Many-to-many with packages
}

// Equipment Package - a preset collection of equipment for easy gym setup
model EquipmentPackage {
  id          String  @id @default(cuid())
  name        String  @unique // e.g., "Standard Ninja Gym", "Basic Fitness Center"
  slug        String  @unique
  description String? @db.Text
  icon        String? // Emoji or icon identifier
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items EquipmentPackageItem[]
}

// Join table: EquipmentPackage <-> Equipment
model EquipmentPackageItem {
  id          String @id @default(cuid())
  packageId   String
  equipmentId String
  quantity    Int    @default(1) // Default quantity when package is applied
  createdAt   DateTime @default(now())

  package   EquipmentPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  equipment Equipment        @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([packageId, equipmentId])
}

// Join table: Discipline <-> Equipment (many-to-many)
model DisciplineEquipment {
  id           String @id @default(cuid())
  disciplineId String
  equipmentId  String
  createdAt    DateTime @default(now())

  discipline Discipline @relation(fields: [disciplineId], references: [id], onDelete: Cascade)
  equipment  Equipment  @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([disciplineId, equipmentId])
}

// Join table: Challenge <-> Equipment (many-to-many)
model ChallengeEquipment {
  id          String @id @default(cuid())
  challengeId String
  equipmentId String
  isRequired  Boolean @default(true) // true = required, false = optional/alternative
  notes       String? // e.g., "Can substitute with rings"
  createdAt   DateTime @default(now())

  challenge  Challenge  @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  equipment  Equipment  @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([challengeId, equipmentId])
}

// ============================================
// CHALLENGES (The Core Content)
// ============================================

// Join table: Challenge <-> Division (many-to-many for allowed divisions)
model ChallengeDivision {
  id          String @id @default(cuid())
  challengeId String
  divisionId  String
  createdAt   DateTime @default(now())

  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  division  Division  @relation(fields: [divisionId], references: [id], onDelete: Cascade)

  @@unique([challengeId, divisionId])
}

// Join table: Challenge <-> Category (many-to-many)
model ChallengeCategory {
  id          String @id @default(cuid())
  challengeId String
  categoryId  String
  sortOrder   Int    @default(0) // For ordering within a category
  createdAt   DateTime @default(now())

  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  category  Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([challengeId, categoryId])
}

// Join table: Challenge <-> Discipline (many-to-many)
model ChallengeDiscipline {
  id           String @id @default(cuid())
  challengeId  String
  disciplineId String
  createdAt    DateTime @default(now())

  challenge  Challenge  @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  discipline Discipline @relation(fields: [disciplineId], references: [id], onDelete: Cascade)

  @@unique([challengeId, disciplineId])
}

// How a challenge is measured/graded
enum GradingType {
  PASS_FAIL   // Simple completion (e.g., "Complete the warped wall")
  REPS        // Count repetitions (e.g., "Pull-ups")
  TIME        // Duration in seconds (e.g., "Hold a dead hang for X seconds")
  DISTANCE    // Distance in meters/feet (e.g., "Broad jump X meters")
  TIMED_REPS  // Reps within a time limit (e.g., "Max pull-ups in 60 seconds")
}

// Graded requirements per division and rank
// Example: Pull-ups for Adult Male at C-rank = 15 reps
model ChallengeGrade {
  id           String  @id @default(cuid())
  challengeId  String
  divisionId   String
  rank         String  // F, E, D, C, B, A, S
  targetValue  Int     // The number to achieve (reps, seconds, etc.)
  description  String? // Optional override text, e.g., "15 strict pull-ups"
  bonusXP      Int     @default(0) // Extra XP for this specific grade
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  division  Division  @relation(fields: [divisionId], references: [id], onDelete: Cascade)

  @@unique([challengeId, divisionId, rank])
}

model Challenge {
  id           String  @id @default(cuid())
  name         String  @unique
  slug         String  @unique
  description  String  @db.Text
  instructions String? @db.Text // How to perform/submit
  demoVideoUrl String? // Vercel Blob URL
  demoImageUrl String? // Vercel Blob URL
  isActive     Boolean @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Grading configuration
  gradingType  GradingType @default(PASS_FAIL) // How is this challenge measured?
  gradingUnit  String?     // e.g., "reps", "seconds", "meters", "feet"
  timeFormat   String?     // For TIME type: "seconds", "mm:ss", "hh:mm:ss"
  minRank      String      @default("F") // Lowest rank this challenge is available for
  maxRank      String      @default("S") // Highest rank this challenge is available for

  // Gym-specific challenge (null = global challenge available to all)
  gymId String?
  gym   Gym?    @relation(fields: [gymId], references: [id], onDelete: SetNull)

  // Categories this challenge appears in (many-to-many)
  categories ChallengeCategory[]

  // Disciplines/sports this challenge belongs to (many-to-many)
  disciplines ChallengeDiscipline[]

  // Equipment required for this challenge (many-to-many)
  equipment ChallengeEquipment[]

  // Graded requirements per division/rank
  grades ChallengeGrade[]

  // Divisions allowed to attempt this challenge (empty = all divisions)
  allowedDivisions ChallengeDivision[]

  // Multi-domain XP distribution (up to 3 domains)
  // Percentages must sum to 100
  // Example: Skill 50%, Strength 40%, Speed 10%
  primaryDomainId    String  // Required - main domain for XP
  primaryXPPercent   Int     @default(100) // 50-100%
  secondaryDomainId  String? // Optional second domain
  secondaryXPPercent Int?    // 0-50%
  tertiaryDomainId   String? // Optional third domain
  tertiaryXPPercent  Int?    // 0-30%

  primaryDomain   Domain  @relation("PrimaryDomain", fields: [primaryDomainId], references: [id])
  secondaryDomain Domain? @relation("SecondaryDomain", fields: [secondaryDomainId], references: [id], onDelete: SetNull)
  tertiaryDomain  Domain? @relation("TertiaryDomain", fields: [tertiaryDomainId], references: [id], onDelete: SetNull)

  rankRequirements RankRequirement[]
  submissions      ChallengeSubmission[]
}

// ============================================
// DIVISIONS (Age/Gender - Admin-Configurable)
// ============================================

model Division {
  id        String  @id @default(cuid())
  name      String // e.g., "Youth Male 8-10", "Adult Female"
  slug      String  @unique
  gender    String? // Male, Female, or null for any
  ageMin    Int? // Minimum age (inclusive)
  ageMax    Int? // Maximum age (inclusive)
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rankRequirements RankRequirement[]
  rankThresholds   RankThreshold[]
  challengeGrades  ChallengeGrade[]
  
  // Challenges that are allowed for this division
  allowedChallenges ChallengeDivision[]
}

// ============================================
// RANK REQUIREMENT MATRIX (The Rubric)
// ============================================

model RankRequirement {
  id              String  @id @default(cuid())
  challengeId     String
  divisionId      String
  requiredForRank String // F, E, D, C, B, A, S
  bonusXP         Int     @default(0) // Extra XP for this division
  isRequired      Boolean @default(true) // vs optional for rank
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  division  Division  @relation(fields: [divisionId], references: [id], onDelete: Cascade)

  @@unique([challengeId, divisionId, requiredForRank])
}

// How many challenges needed per category to advance rank
model RankThreshold {
  id              String  @id @default(cuid())
  divisionId      String
  domainId        String
  rank            String // The rank being unlocked (e.g., "C" means moving from D to C)
  categoryId      String? // If null, applies to whole domain
  requiredCount   Int // N of M challenges required
  totalInCategory Int? // M (optional, can be calculated)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  division Division @relation(fields: [divisionId], references: [id], onDelete: Cascade)

  @@unique([divisionId, domainId, rank, categoryId])
}

// ============================================
// ATHLETE PROGRESS
// ============================================

model DomainLevel {
  id        String @id @default(cuid())
  athleteId String
  domainId  String
  letter    String @default("F") // F, E, D, C, B, A, S
  sublevel  Int    @default(0) // 0-9
  currentXP Int    @default(0)
  bankedXP  Int    @default(0) // XP waiting for breakthrough
  updatedAt DateTime @updatedAt

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  domain  Domain  @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@unique([athleteId, domainId])
}

model XPTransaction {
  id        String   @id @default(cuid())
  athleteId String
  domainId  String
  amount    Int
  source    XPSource
  sourceId  String? // Reference to challenge submission, competition, etc.
  note      String?
  createdAt DateTime @default(now())

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  domain  Domain  @relation(fields: [domainId], references: [id], onDelete: Cascade)
}

enum XPSource {
  CHALLENGE
  TRAINING
  COMPETITION
  EVENT
  BONUS
  ADMIN
}

// ============================================
// CHALLENGE SUBMISSIONS
// ============================================

model ChallengeSubmission {
  id            String           @id @default(cuid())
  athleteId     String
  challengeId   String
  submittedById String // User who submitted (parent or athlete themselves)
  videoUrl      String? // Vercel Blob URL
  imageUrl      String? // Vercel Blob URL
  notes         String?
  status        SubmissionStatus @default(PENDING)
  autoApproved  Boolean          @default(false) // True if submitter was Coach/Admin
  reviewedBy    String? // User ID of reviewer
  reviewNotes   String?
  submittedAt   DateTime         @default(now())
  reviewedAt    DateTime?

  // For graded challenges: what value did they achieve?
  achievedValue Int? // e.g., 20 reps, 45 seconds, etc.
  
  // Which rank tier did they achieve? (F, E, D, C, B, A, S)
  achievedRank  String? // Calculated from achievedValue vs ChallengeGrade targets
  
  // Which tiers have been claimed for XP? (prevents re-farming)
  // Stored as comma-separated: "F,E,D,C" means F through C tiers claimed
  claimedTiers  String  @default("") // Empty = none claimed yet
  
  // Total XP awarded across all claimed tiers
  xpAwarded     Int     @default(0)

  athlete   Athlete             @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  challenge Challenge           @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  history   SubmissionHistory[] // Previous versions

  @@unique([athleteId, challengeId]) // One active submission per challenge per athlete
}

// Keeps history of resubmissions for audit
model SubmissionHistory {
  id           String           @id @default(cuid())
  submissionId String
  videoUrl     String?
  imageUrl     String?
  notes        String?
  status       SubmissionStatus
  reviewedBy   String?
  reviewNotes  String?
  submittedAt  DateTime
  reviewedAt   DateTime?
  version      Int
  archivedAt   DateTime         @default(now())

  submission ChallengeSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_REVISION
}

// ============================================
// FUTURE: COMPETITIONS
// ============================================

model Competition {
  id        String   @id @default(cuid())
  name      String
  date      DateTime
  location  String?
  sport     String
  domains   String[] // Which domains this affects
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  results CompetitionResult[]
}

model CompetitionResult {
  id                String   @id @default(cuid())
  competitionId     String
  athleteId         String
  placement         Int
  totalParticipants Int
  xpAwarded         Int
  createdAt         DateTime @default(now())

  competition Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
}

// ============================================
// GYMS
// ============================================

model Gym {
  id            String  @id @default(cuid())
  name          String
  slug          String  @unique
  description   String? @db.Text
  logoUrl       String?
  bannerUrl     String?
  website       String?
  googlePlaceId String? // Google Places API place_id for Maps integration
  address       String?
  city          String?
  state         String?
  country       String?
  zipCode       String?
  phone         String?
  email         String?
  isActive      Boolean @default(true)
  isVerified    Boolean @default(false) // Admin-verified gym
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Owner (the user who created/owns this gym)
  ownerId String
  owner   User   @relation("GymOwner", fields: [ownerId], references: [id])

  // Relationships
  members     GymMember[]      // Users who are members/staff of this gym
  equipment   GymEquipment[]   // Equipment this gym has
  disciplines GymDiscipline[]  // Disciplines this gym focuses on
  challenges  Challenge[]      // Gym-specific challenges
}

// Gym membership role
enum GymRole {
  MEMBER  // Regular member
  COACH   // Can review submissions
  MANAGER // Can manage gym settings, equipment, challenges
  OWNER   // Full control (set automatically for gym creator)
}

// Join table: User <-> Gym (many-to-many with role)
model GymMember {
  id        String   @id @default(cuid())
  gymId     String
  userId    String
  role      GymRole  @default(MEMBER)
  joinedAt  DateTime @default(now())
  isActive  Boolean  @default(true)
  
  // Privacy: whether to show on public gym member list
  // Only applies if user's athlete profile also has isPublicProfile=true
  isPublicMember Boolean @default(false)

  gym  Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([gymId, userId])
}

// Join table: Gym <-> Equipment (what equipment the gym has)
model GymEquipment {
  id          String   @id @default(cuid())
  gymId       String
  equipmentId String
  quantity    Int      @default(1) // How many of this equipment
  notes       String?  // e.g., "14ft warped wall"
  createdAt   DateTime @default(now())

  gym       Gym       @relation(fields: [gymId], references: [id], onDelete: Cascade)
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([gymId, equipmentId])
}

// Join table: Gym <-> Discipline (what disciplines the gym focuses on)
model GymDiscipline {
  id           String   @id @default(cuid())
  gymId        String
  disciplineId String
  isPrimary    Boolean  @default(false) // Main discipline for the gym
  createdAt    DateTime @default(now())

  gym        Gym        @relation(fields: [gymId], references: [id], onDelete: Cascade)
  discipline Discipline @relation(fields: [disciplineId], references: [id], onDelete: Cascade)

  @@unique([gymId, disciplineId])
}
